# 운영 편의/청소 — 상황·문제·해결

## 목적과 요구
- 운영 중 즉시 확인 가능한 **빠른 헬스체크 루틴** 마련
- Nginx 기동 시 반복 출력되던 **헤더 해시 경고 억제**로 로그 소음 감소
- 문제 발생 시 원인 분리 시간을 단축하고, 배포/갱신 절차와 충돌하지 않도록 구성 유지

---

## 초기 상황
- 인증서 발급을 HTTP-01(webroot)로 전환하며 `/.well-known/acme-challenge/` 경로가 중요해짐
- Nginx 리로드 때마다 아래 경고가 반복 출력되어 실질 오류 식별이 어려움  
  `could not build optimal proxy_headers_hash, you should increase either proxy_headers_hash_max_size or proxy_headers_hash_bucket_size`

---

## 문제 증상
- ACME 경로 이상 시 certbot 갱신이 404로 실패하나, 웹서버·포워딩·경로 등 어느 레이어 문제인지 즉시 판별 어려움
- Nginx 경고가 매번 섞여 나와 실제 에러와 구분이 번거로움

---

## 해결 조치 요약
- **ACME 헬스 파일**을 만들어 HTTP/HTTPS 양 경로에서 즉시 점검 가능하도록 함
- Nginx `http {}` 블록에 **헤더 해시 파라미터**를 명시하여 경고 억제

---

## 실제 적용 내용

### 1) ACME 헬스 파일로 빠른 점검 루틴 마련
- 목적: 파일 하나로 **라우터 포워딩 → Nginx 8081/8443 → webroot 경로**까지 한 번에 검증
- 준비
```bash
mkdir -p /var/www/certbot/.well-known/acme-challenge
echo ok > /var/www/certbot/.well-known/acme-challenge/health.txt
```
- 점검 예시
```bash
# HTTP(8081)에서 ACME 파일 응답 확인
curl -I http://127.0.0.1:8081/.well-known/acme-challenge/health.txt

# HTTPS(8443)에서 SNI 포함 로컬 확인
curl -I -k --resolve totheballpark.info:8443:127.0.0.1   https://totheballpark.info:8443/.well-known/acme-challenge/health.txt
```
- 기대
  - 8081은 ACME 경로에서 200이 반환되어야 함
  - 루트 `/` 요청은 301로 HTTPS로 이동해야 함
  - 8443은 200 또는 301/302가 반환되며, 파일 경로를 직접 지정하면 200 확인 가능

### 2) Nginx 헤더 해시 경고 억제
- 위치: `/etc/nginx/nginx.conf` 의 `http { ... }` 블록 내부
- 추가
```nginx
http {
    # ...기존 설정들...

    proxy_headers_hash_max_size 1024;
    proxy_headers_hash_bucket_size 128;
}
```
- 적용 및 확인
```bash
nginx -t && nginx -s reload
# 경고가 더 이상 출력되지 않아야 함
```
- 효과: 프록시 헤더가 많은 환경에서도 해시 테이블 크기를 충분히 확보하여 최적 구성을 보장하고, 불필요한 경고 노이즈 제거

---

## 진행 중 문제와 해결
- **헬스체크가 301만 보이는 경우**  
  → 루트 경로를 확인한 것이며 정상, 파일 경로로 직접 요청하여 200 확인
- **ACME 경로가 404인 경우**  
  → 8081/8443 두 서버블록 모두에 `location /.well-known/acme-challenge/ { root /var/www/certbot; }` 존재 확인, 리다이렉트 블록보다 **위에 배치**
- **경고가 계속 보이는 경우**  
  → `nginx.conf` 가 아닌 사이트 파일에 추가했을 가능성, 반드시 `http {}` 블록에 배치하고 리로드로 반영

---

## 결과
- 한 줄 명령으로 ACME 경로와 리다이렉트 동작을 즉시 검증 가능
- Nginx 경고 억제로 실제 오류 탐지가 쉬워져 운영 효율 향상
- 인증서 갱신 및 일반 트래픽 경로의 상태를 빠르게 분리 진단할 수 있게 됨

---

## 운영 체크리스트
- `/var/www/certbot/.well-known/acme-challenge/health.txt` 가 존재하는지 확인
- `curl -I http://127.0.0.1:8081/.well-known/acme-challenge/health.txt` 가 200인지 확인
- `curl -I -k --resolve totheballpark.info:8443:127.0.0.1 https://totheballpark.info:8443` 가 200/301/302인지 확인
- `nginx -t && nginx -s reload` 시 프록시 헤더 해시 경고가 출력되지 않는지 확인