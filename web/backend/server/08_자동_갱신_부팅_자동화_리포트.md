# 자동 갱신/부팅 자동화 — 상황·문제·해결

## 목적과 요구
- 인증서 갱신을 **사람 개입 없이** 주기적으로 수행
- systemd 없는 환경에서 **cron 기반**으로 동작
- 컨테이너 재시작·정전 이후에도 **Nginx, Gunicorn, cron** 이 자동으로 복구
- 갱신 성공 시 **무중단으로 Nginx 재로드**

---

## 초기 상황
- 컨테이너/비‑systemd 환경이라 `systemctl` 사용 불가
- 초기에 `certbot renew --dry-run` 이 스테이징 리졸버 캐시 문제로 실패
- ACME 경로는 `/var/www/certbot` 으로 운영 중이며 8081/8443 모두에서 파일 서빙

---

## 문제 증상
- `renew --dry-run` 에서 `www.totheballpark.info` NXDOMAIN 과 `/.well-known/...` 404가 간헐 재현
- 컨테이너가 재기동되면 **cron 데몬이 내려가** 스케줄이 실행되지 않음
- systemd 부재로 **서비스 자동 시작**을 간편히 걸 수 없음

---

## 해결 전략
- 실제 성공했던 명령을 그대로 사용하도록 **`certonly --webroot` 방식**을 크론에 등록
- 부팅 시 필요한 데몬과 프로세스를 일괄 기동하는 **`/root/boot-up.sh`** 작성
- @reboot 훅으로 **재부팅 이후 복구**를 보장

---

## 실제 적용 내용

### 1) 갱신 명령 고정화(webroot)
- `renew` 대신 **성공 경로인 `certonly --webroot`** 를 스케줄에 사용
- 이미 유효한 인증서가 있으면 그대로 두고, 만료 임박 시에만 재발급하도록 `--keep-until-expiring` 사용
```bash
0 3 * * * certbot certonly --webroot -w /var/www/certbot   -d totheballpark.info -d www.totheballpark.info   --keep-until-expiring --quiet && nginx -s reload
```

### 2) cron 데몬 설치·기동
```bash
apt update && apt install -y cron
cron  # systemd 없이 데몬을 직접 기동
```
- 컨테이너 재가동 시 부팅 스크립트에서 다시 실행

### 3) 부팅 스크립트 작성
- 경로: `/root/boot-up.sh`
- 역할: **cron 기동**, **Nginx 기동/재적용**, **Gunicorn 재기동**, **간단 헬스체크 기록**
```bash
#!/usr/bin/env bash
set -euo pipefail
APP_DIR="/root/tothe_ballpark"
VENV_DIR="/root/tothe_ballpark/venv-py310"
GUNICORN_BIND="127.0.0.1:8000"
GUNICORN_MODULE="baseball.wsgi:application"
mkdir -p /var/www/certbot/.well-known/acme-challenge /var/log

# cron
pgrep -x cron >/dev/null 2>&1 || cron

# nginx
nginx -t && ( pgrep -x nginx >/dev/null 2>&1 && nginx -s reload || nginx )

# gunicorn 재기동
pkill -f "gunicorn.*${GUNICORN_BIND}" || true
nohup "${VENV_DIR}/bin/gunicorn" --chdir "${APP_DIR}"   --workers 3 --bind "${GUNICORN_BIND}" "${GUNICORN_MODULE}"   > /var/log/gunicorn.log 2>&1 &
```
- 등록
```bash
@reboot /root/boot-up.sh >> /var/log/bootup.log 2>&1
```

### 4) 헬스체크 루틴
```bash
# ACME 경로
curl -I http://127.0.0.1:8081/.well-known/acme-challenge/health.txt
# HTTPS(SNI) 내부 점검
curl -I -k --resolve totheballpark.info:8443:127.0.0.1 https://totheballpark.info:8443
# 백엔드
curl -I http://127.0.0.1:8000
```

### 5) 인증서 상태 확인 명령
```bash
certbot certificates
openssl x509 -in /etc/letsencrypt/live/totheballpark.info/fullchain.pem -noout -enddate
```

---

## 진행 중 문제와 해결
- **스테이징 리졸버 캐시로 인한 `renew --dry-run` 실패**  
  → `certonly --webroot` 를 크론에 등록해 **실행 경로를 고정**하고 `--keep-until-expiring` 으로 불필요한 재발급 방지
- **cron 비기동 문제**  
  → `cron` 패키지 설치 후 데몬을 직접 띄우고, 부팅 스크립트에서 재기동 처리
- **서비스 자동 시작 부재**  
  → `@reboot /root/boot-up.sh` 로 **Nginx·Gunicorn·cron** 을 일괄 복구

---

## 결과
- 매일 03:00에 인증서 갱신 시도 및 성공 시 자동으로 Nginx 재로드
- 재부팅이나 컨테이너 재시작 시에도 부팅 스크립트로 핵심 프로세스가 즉시 복구
- 점검 명령이 표준화되어 문제 발생 시 원인 분리가 빨라짐

---

## 운영 체크리스트
- `crontab -l` 에 03:00 스케줄과 `@reboot` 항목이 존재하는지 확인
- 컨테이너 재시작 후 `cron`, `nginx`, `gunicorn` 이 살아 있는지 확인
	- 컨테이너 재시작 시 cron 재기동 해야함 주의
- `/var/log/bootup.log` 와 `/var/log/gunicorn.log` 로 부팅/애플리케이션 로그 확인
- 인증서 만료 30일 이내에 자동 갱신이 이루어지는지 `certbot certificates` 로 주기 확인