# 서비스 구조 확정 — 상황·문제·해결 정리

## 목적
- **표준 포트(80/443)로 도메인 접속**을 제공하면서
- **systemd가 없는 컨테이너형 환경**에서도 안정적으로 서비스 운영
- 애플리케이션은 **Gunicorn(127.0.0.1:8000)** 으로만 노출하고, **Nginx가 프록시/정적 서빙**을 담당
- **Let's Encrypt 인증서** 적용 및 이후 **자동 갱신 경로 확보**

---

## 초기 상황과 제약
- 서버 환경은 **systemd 부재(컨테이너/WSL 계열)** → `systemctl` 사용 불가
- **특권 포트(80/443) 바인딩 권한 부족** → `bind() to 0.0.0.0:80 failed (13: Permission denied)`
- 초기에 Nginx 설정에 아직 없는 인증서 경로를 참조하여 **nginx -t 실패**
- 외부에서 표준 포트로 접속을 원하지만, 호스트에서 80/443을 직접 열 수 없음
- 로컬 확인 시 **헤어핀 NAT 미지원**으로 내부에서 도메인:443 접속 실패 가능성

---

## 목표 아키텍처
```
[Internet]  ──(80/443)──> [라우터]
   80  ───────────────┐
   443 ───────────────┴─────► Port Forwarding
                           80  ->  8081 (Nginx HTTP)
                           443 ->  8443 (Nginx HTTPS)

[Nginx] : 8081, 8443
  └─ proxy_pass → 127.0.0.1:8000 (Gunicorn/Django)
  └─ /static, /media  alias 서빙
  └─ /.well-known/acme-challenge  (HTTP-01용 webroot)

[Gunicorn] : 127.0.0.1:8000
  └─ Django(WSGI) 애플리케이션
```

핵심 포인트
- **외부 표준 포트는 라우터가 수신**하고 내부로 포워딩
- **Nginx는 고포트(8081/8443)에서 리슨**, 앱은 **로컬루프백 8000**으로만 수신
- 인증은 **webroot(HTTP-01)** 로 운영, `/.well-known/acme-challenge` 를 8081·8443 모두에서 서빙

---

## 진행 중 발생한 문제와 해결
### 1) Nginx 테스트/리로드 실패
- 증상: `/etc/letsencrypt/live/...` 경로가 없는데 443 블록에서 참조 → `nginx -t` 실패
- 해결: **발급 전 단계**는 **80/8081만** 두고 SSL 레퍼런스 제거 → `nginx -t && nginx -s reload` 성공

### 2) systemd 부재로 `systemctl reload nginx` 불가
- 증상: `System has not been booted with systemd as init system`
- 해결: **신호 기반 제어** 사용 → `nginx -s reload`, 미기동 시 `nginx` 로 데몬 시작

### 3) 502 Bad Gateway
- 원인: 업스트림 `127.0.0.1:8000` 미기동(혹은 경로 불일치)
- 해결: 정확한 venv 경로(`venv-py310`)와 WSGI 모듈(`baseball.wsgi:application`)로 **gunicorn 백그라운드 실행**
  ```bash
  nohup /root/tothe_ballpark/venv-py310/bin/gunicorn     --chdir /root/tothe_ballpark --workers 3 --bind 127.0.0.1:8000     baseball.wsgi:application > /var/log/gunicorn.log 2>&1 &
  ```

### 4) 400 Bad Request (DisallowedHost)
- 원인: 내부 테스트 시 Host가 `127.0.0.1`인데 `ALLOWED_HOSTS`에 없음
- 해결: `ALLOWED_HOSTS`에 `127.0.0.1`, `localhost`, 실도메인, 공인IP 등 추가

### 5) DNS-01 반복 실패
- 원인: 관리 UI 특성/캐시로 **예전 TXT 값만 권한 NS에 퍼블리시**, 혹은 값 교체/추가 순서 혼선
- 해결: **권한 네임서버(ns1~ns4.hosting.co.kr) 직접 질의** 루틴 마련 후 값 일치 확인 →
  - 최종적으로 **HTTP-01(webroot)** 로 전략 전환

### 6) HTTP-01로 전환 후 인증/적용
- 조치:
  - 8081/8443 모두에 `/.well-known/acme-challenge` 경로 서빙
  - 공유기에서 **80→8081**, **443→8443** 포워딩 확인
  - `certbot certonly --webroot -w /var/www/certbot -d totheballpark.info -d www.totheballpark.info` 성공
- 검증:
  - 내부: `curl -I -k --resolve totheballpark.info:8443:127.0.0.1 https://totheballpark.info:8443`
  - 외부(LTE): `https://totheballpark.info` 정상

### 7) www 서브도메인 NXDOMAIN
- 원인: 공개 리졸버 일부에서 예전 `CNAME www → @` 캐시가 잔존
- 해결: **A www → 125.243.101.110** 로 전환(권한 NS 확인), 캐시 경과 후 정상화

### 8) HTTP→HTTPS 강제 및 보안옵션
- 8081: ACME 예외 외 모두 `return 301 https://$host$request_uri;`
- Django: `CSRF_COOKIE_SECURE=True`, `SESSION_COOKIE_SECURE=True`, `CSRF_TRUSTED_ORIGINS` 정리

---

## 최종 구성 스냅샷
- **Nginx**
  - 8081: `/.well-known/acme-challenge/`만 파일 서빙, 그 외 전부 301 → HTTPS
  - 8443: 인증서 적용, 정적/미디어 alias, 프록시 → 127.0.0.1:8000
- **Gunicorn**: 127.0.0.1:8000, 워커 3개
- **DNS**
  - A @ → 125.243.101.110
  - A www → 125.243.101.110
- **포트포워딩(라우터)**
  - 80 → 8081
  - 443 → 8443
- **인증서**
  - 발급 완료(유효기간: 2025-11-11), 이후 **webroot 갱신** 경로 확보
- **운영 점검 단축키**
  ```bash
  curl -I http://127.0.0.1:8081/.well-known/acme-challenge/health.txt   # 200
  curl -I -k --resolve totheballpark.info:8443:127.0.0.1 https://totheballpark.info:8443  # 200/301/302
  ```

---

## 대안 검토와 선택 이유
- **대안 A: 컨테이너에 CAP_NET_BIND_SERVICE 부여(80/443 직접 리슨)**  
  - 장점: 라우터 의존도 축소  
  - 단점: 컨테이너/보안 정책 조정 필요, 현재 운영 경로와 괴리
- **대안 B: DNS-01 고정 운영**  
  - 장점: 80/443 필요 없음  
  - 단점: TXT 전파/관리자 UI 특성에 민감, 갱신 시마다 동일 문제 재현 가능
- **선택: HTTP-01(webroot) + 라우터 포워딩**  
  - 이유: 현 네트워크/권한 제약에 가장 단순·안정, 갱신 자동화 용이

---

## 후속 권고
- 컨테이너 재기동 시 `cron` 자동 기동 확인(부팅 스크립트에 포함)
- Nginx 경고 정리(선택): `nginx.conf` `http {{...}}` 안에
  ```
  proxy_headers_hash_max_size 1024;
  proxy_headers_hash_bucket_size 128;
  ```
- 필요 시 HSTS 추가:  
  `add_header Strict-Transport-Security "max-age=31536000" always;`